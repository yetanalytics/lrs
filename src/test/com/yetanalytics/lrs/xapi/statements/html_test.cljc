(ns com.yetanalytics.lrs.xapi.statements.html-test
  (:require #?@(:clj  [[hiccup2.core :as html]]
                :cljs [[hiccups.runtime :as hic]
                       goog.string.format])
            [clojure.string :refer [replace]]
            [clojure.test :refer [deftest testing is] :include-macros true]
            [com.yetanalytics.lrs.pedestal.routes.statements.html.json :as json]))


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Dissoc Statement property test
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(def sample-sketchy-statement
  {"id"     "030e001f-b32a-4361-b701-039a3d9fceb1"
   ;; actor injection
   "actor"   {"account" {"homePage" "http://www.homepage.com"
                         "name"     "<script>alert('hi')</script>"}}
   "object"  {"id"      "http://www.example.com/activity1"}
   "verb"    {"id"      "http://www.example.com/verbs/hacked"
              "display" {"en-us" "Hacked"}}
   "context" {"extensions"
              {"http://www.exmpl.co/ext1" {;; key injection
                                           "<script>alert('hi')</script>"
                                           ;; value injection
                                           "<script>alert('hi')</script>"}}}})

(def expected-sanitized-render
  #?(:clj  "<div class=\"json json-map\" data-count=\"5\" data-json=\"{\n  &quot;id&quot; : &quot;030e001f-b32a-4361-b701-039a3d9fceb1&quot;,\n  &quot;actor&quot; : {\n    &quot;account&quot; : {\n      &quot;homePage&quot; : &quot;http://www.homepage.com&quot;,\n      &quot;name&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n    }\n  },\n  &quot;object&quot; : {\n    &quot;id&quot; : &quot;http://www.example.com/activity1&quot;\n  },\n  &quot;verb&quot; : {\n    &quot;id&quot; : &quot;http://www.example.com/verbs/hacked&quot;,\n    &quot;display&quot; : {\n      &quot;en-us&quot; : &quot;Hacked&quot;\n    }\n  },\n  &quot;context&quot; : {\n    &quot;extensions&quot; : {\n      &quot;http://www.exmpl.co/ext1&quot; : {\n        &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n      }\n    }\n  }\n}\" data-path=\"\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"id\"><div class=\"json json-map-entry-key\">id</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"id\" data-scalar-value=\"030e001f-b32a-4361-b701-039a3d9fceb1\">030e001f-b32a-4361-b701-039a3d9fceb1</div></div></div><input class=\"truncator\" id=\"bfcb2b14-b7de-4de1-b1a0-c0d50d2e6760\" style=\"display:none;\" type=\"checkbox\" /><label class=\"truncator-label plural\" for=\"bfcb2b14-b7de-4de1-b1a0-c0d50d2e6760\">4</label><div class=\"json json-map-entry\" data-entry-idx=\"1\" data-entry-key-name=\"actor\"><div class=\"json json-map-entry-key\">actor</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &quot;account&quot; : {\n    &quot;homePage&quot; : &quot;http://www.homepage.com&quot;,\n    &quot;name&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n  }\n}\" data-path=\"actor\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"account\"><div class=\"json json-map-entry-key\">account</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"2\" data-json=\"{\n  &quot;homePage&quot; : &quot;http://www.homepage.com&quot;,\n  &quot;name&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n}\" data-path=\"actor,account\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"homePage\"><div class=\"json json-map-entry-key\">homePage</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"actor,account,homePage\" data-scalar-value=\"http://www.homepage.com\"><a href=\"http://www.homepage.com\" target=\"_blank\">http://www.homepage.com</a></div></div></div><input class=\"truncator\" id=\"daaa4f66-7fc1-43eb-8b4f-4e31b2b7c5c9\" style=\"display:none;\" type=\"checkbox\" /><label class=\"truncator-label\" for=\"daaa4f66-7fc1-43eb-8b4f-4e31b2b7c5c9\">1</label><div class=\"json json-map-entry\" data-entry-idx=\"1\" data-entry-key-name=\"name\"><div class=\"json json-map-entry-key\">name</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"actor,account,name\" data-scalar-value=\"&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;\">&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;</div></div></div></div></div></div></div></div></div><div class=\"json json-map-entry\" data-entry-idx=\"2\" data-entry-key-name=\"object\"><div class=\"json json-map-entry-key\">object</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &quot;id&quot; : &quot;http://www.example.com/activity1&quot;\n}\" data-path=\"object\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"id\"><div class=\"json json-map-entry-key\">id</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"object,id\" data-scalar-value=\"http://www.example.com/activity1\"><a href=\"http://www.example.com/activity1\" target=\"_blank\">http://www.example.com/activity1</a></div></div></div></div></div></div><div class=\"json json-map-entry\" data-entry-idx=\"3\" data-entry-key-name=\"verb\"><div class=\"json json-map-entry-key\">verb</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"2\" data-json=\"{\n  &quot;id&quot; : &quot;http://www.example.com/verbs/hacked&quot;,\n  &quot;display&quot; : {\n    &quot;en-us&quot; : &quot;Hacked&quot;\n  }\n}\" data-path=\"verb\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"id\"><div class=\"json json-map-entry-key\">id</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"verb,id\" data-scalar-value=\"http://www.example.com/verbs/hacked\"><a href=\"http://www.example.com/verbs/hacked\" target=\"_blank\">http://www.example.com/verbs/hacked</a></div></div></div><input class=\"truncator\" id=\"3f32f1c4-7dd8-4dd1-b1f1-f12fb00a951b\" style=\"display:none;\" type=\"checkbox\" /><label class=\"truncator-label\" for=\"3f32f1c4-7dd8-4dd1-b1f1-f12fb00a951b\">1</label><div class=\"json json-map-entry\" data-entry-idx=\"1\" data-entry-key-name=\"display\"><div class=\"json json-map-entry-key\">display</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &quot;en-us&quot; : &quot;Hacked&quot;\n}\" data-path=\"verb,display\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"en-us\"><div class=\"json json-map-entry-key\">en-us</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"verb,display,en-us\" data-scalar-value=\"Hacked\">Hacked</div></div></div></div></div></div></div></div></div><div class=\"json json-map-entry\" data-entry-idx=\"4\" data-entry-key-name=\"context\"><div class=\"json json-map-entry-key\">context</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &quot;extensions&quot; : {\n    &quot;http://www.exmpl.co/ext1&quot; : {\n      &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n    }\n  }\n}\" data-path=\"context\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"extensions\"><div class=\"json json-map-entry-key\">extensions</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &quot;http://www.exmpl.co/ext1&quot; : {\n    &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n  }\n}\" data-path=\"context,extensions\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"http://www.exmpl.co/ext1\"><div class=\"json json-map-entry-key\"><a href=\"http://www.exmpl.co/ext1\" target=\"_blank\">http://www.exmpl.co/ext1</a></div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot; : &quot;&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;&quot;\n}\" data-path=\"context,extensions,http://www.exmpl.co/ext1\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;\"><div class=\"json json-map-entry-key\">&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"context,extensions,http://www.exmpl.co/ext1,&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;\" data-scalar-value=\"&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;\">&lt;script&gt;alert(&apos;hi&apos;)&lt;/script&gt;</div></div></div></div></div></div></div></div></div></div></div></div></div>"
     :cljs "<div class=\"json json-map\" data-count=\"5\" data-json=\"{\n  &amp;quot;id&quot;: &quot;&quot;,\n  &quot;actor&quot;: {\n    &quot;account&quot;: {\n      &quot;homePage&quot;: &quot;http://www.homepage.com&quot;,\n      &quot;name&quot;: &quot;&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;&quot;\n    }\n  },\n  &quot;object&quot;: {\n    &quot;id&quot;: &quot;http://www.example.com/activity1&quot;\n  },\n  &quot;verb&quot;: {\n    &quot;id&quot;: &quot;http://www.example.com/verbs/hacked&quot;,\n    &quot;display&quot;: {\n      &quot;en-us&quot;: &quot;Hacked&quot;\n    }\n  },\n  &quot;context&quot;: {\n    &quot;extensions&quot;: {\n      &quot;http://www.exmpl.co/ext1&quot;: {\n        &quot;&lt;script&gt;alert('hi')&lt;/script&gt;&quot;: &quot;&lt;script&gt;alert('hi')&lt;/script&gt;&quot;\n      }\n    }\n  }\n}\" data-path=\"\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"id\"><div class=\"json json-map-entry-key\">id</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"id\" data-scalar-value=\"\"></div></div></div><input class=\"truncator\" id=\"\" style=\"display:none;\" type=\"checkbox\" /><label class=\"truncator-label plural\" for=\"\">4</label><div class=\"json json-map-entry\" data-entry-idx=\"1\" data-entry-key-name=\"actor\"><div class=\"json json-map-entry-key\">actor</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &amp;quot;account&quot;: {\n    &quot;homePage&quot;: &quot;http://www.homepage.com&quot;,\n    &quot;name&quot;: &quot;&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;&quot;\n  }\n}\" data-path=\"actor\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"account\"><div class=\"json json-map-entry-key\">account</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"2\" data-json=\"{\n  &amp;quot;homePage&quot;: &quot;http://www.homepage.com&quot;,\n  &quot;name&quot;: &quot;&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;&quot;\n}\" data-path=\"actor,account\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"homePage\"><div class=\"json json-map-entry-key\">homePage</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"actor,account,homePage\" data-scalar-value=\"http://www.homepage.com\"><a href=\"http://www.homepage.com\" target=\"_blank\">http://www.homepage.com</a></div></div></div><input class=\"truncator\" id=\"\" style=\"display:none;\" type=\"checkbox\" /><label class=\"truncator-label\" for=\"\">1</label><div class=\"json json-map-entry\" data-entry-idx=\"1\" data-entry-key-name=\"name\"><div class=\"json json-map-entry-key\">name</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"actor,account,name\" data-scalar-value=\"&lt;script&gt;alert('hi')&lt;/script&gt;\">&lt;script&gt;alert(&#39;hi')</script></div></div></div></div></div></div></div></div></div><div class=\"json json-map-entry\" data-entry-idx=\"2\" data-entry-key-name=\"object\"><div class=\"json json-map-entry-key\">object</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &amp;quot;id&quot;: &quot;http://www.example.com/activity1&quot;\n}\" data-path=\"object\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"id\"><div class=\"json json-map-entry-key\">id</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"object,id\" data-scalar-value=\"http://www.example.com/activity1\"><a href=\"http://www.example.com/activity1\" target=\"_blank\">http://www.example.com/activity1</a></div></div></div></div></div></div><div class=\"json json-map-entry\" data-entry-idx=\"3\" data-entry-key-name=\"verb\"><div class=\"json json-map-entry-key\">verb</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"2\" data-json=\"{\n  &amp;quot;id&quot;: &quot;http://www.example.com/verbs/hacked&quot;,\n  &quot;display&quot;: {\n    &quot;en-us&quot;: &quot;Hacked&quot;\n  }\n}\" data-path=\"verb\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"id\"><div class=\"json json-map-entry-key\">id</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"verb,id\" data-scalar-value=\"http://www.example.com/verbs/hacked\"><a href=\"http://www.example.com/verbs/hacked\" target=\"_blank\">http://www.example.com/verbs/hacked</a></div></div></div><input class=\"truncator\" id=\"\" style=\"display:none;\" type=\"checkbox\" /><label class=\"truncator-label\" for=\"\">1</label><div class=\"json json-map-entry\" data-entry-idx=\"1\" data-entry-key-name=\"display\"><div class=\"json json-map-entry-key\">display</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &amp;quot;en-us&quot;: &quot;Hacked&quot;\n}\" data-path=\"verb,display\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"en-us\"><div class=\"json json-map-entry-key\">en-us</div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"verb,display,en-us\" data-scalar-value=\"Hacked\">Hacked</div></div></div></div></div></div></div></div></div><div class=\"json json-map-entry\" data-entry-idx=\"4\" data-entry-key-name=\"context\"><div class=\"json json-map-entry-key\">context</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &amp;quot;extensions&quot;: {\n    &quot;http://www.exmpl.co/ext1&quot;: {\n      &quot;&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;&quot;: &quot;&lt;script&gt;alert('hi')&lt;/script&gt;&quot;\n    }\n  }\n}\" data-path=\"context\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"extensions\"><div class=\"json json-map-entry-key\">extensions</div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &amp;quot;http://www.exmpl.co/ext1&quot;: {\n    &quot;&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;&quot;: &quot;&lt;script&gt;alert('hi')&lt;/script&gt;&quot;\n  }\n}\" data-path=\"context,extensions\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"http://www.exmpl.co/ext1\"><div class=\"json json-map-entry-key\"><a href=\"http://www.exmpl.co/ext1\" target=\"_blank\">http://www.exmpl.co/ext1</a></div><div class=\"json json-map-entry-val\"><div class=\"json json-map\" data-count=\"1\" data-json=\"{\n  &amp;quot;&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;&quot;: &quot;&lt;script&gt;alert('hi')&lt;/script&gt;&quot;\n}\" data-path=\"context,extensions,http://www.exmpl.co/ext1\"><div class=\"json json-map-entry\" data-entry-idx=\"0\" data-entry-key-name=\"&amp;amp;lt;script&amp;gt;alert(&amp;#39;hi&amp;#39;)&amp;lt;/script&amp;gt;\"><div class=\"json json-map-entry-key\">&lt;script&gt;alert(&#39;hi')</script></div><div class=\"json json-map-entry-val scalar\"><div class=\"json json-scalar\" data-path=\"context,extensions,http://www.exmpl.co/ext1,&amp;lt;script&amp;gt;alert(&amp;#39;hi')&lt;/script&gt;\" data-scalar-value=\"&lt;script&gt;alert('hi')&lt;/script&gt;\">&lt;script&gt;alert(&#39;hi')</script></div></div></div></div></div></div></div></div></div></div></div></div></div>"))

(def uuid-regex
  #"[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}")

(defn strip-uuids
  [input]
  (replace input uuid-regex ""))

(deftest dissoc-statement-properties-nongen-test
  (testing "sketchy statement renders safely"
    (let [hvec     (json/json->hiccup sample-sketchy-statement)
          rendered (#?(:clj  html/html
                       :cljs hic/render-html) 
                    hvec)]
      (is (= (strip-uuids (str rendered)) 
             (strip-uuids expected-sanitized-render))))))


